# 基于Arduino平台的ESP32可视化超声波测距方案

你可以在这里观看成品演示视频：[【基于Arduino平台的ESP32可视化超声波测距方案-哔哩哔哩】](https://b23.tv/39lHdYG)


演示视频没有任何讲解。配置为每测量五次才进行一次绘制，所以看起来很慢。使用源代码配置（测量次数为2）测试时，目测显示屏刷新率达到30fps左右。

## 功能特性

本项目正常运行时，可以进行短距离测距。
测距远距离极限约为 400 mm，近距离极限约为 30 mm。此范围之外返回的数据是不可靠的！
测距分辨率可达 1 mm。

每次测距为阻塞操作，需要 20ms 左右的时间。可以多次测距取平均值。你可以指定每次测距的次数。

测距完成后，显示屏上方会显示数值形式的测试距离。下方显示连续测距结果的直方图记录。如果屏幕溢满，会从屏幕左侧以异色继续绘制并覆盖之前测量的结果。

注意，在以下情况时运行不正常，并可能诱发异常结果：

1. 连接线接触不良：显示屏不显示或显示异常、超声波模块不工作或传回结果不稳定。
2. 供电不足：显示屏或超声波模块不工作。当然，也可能一起罢工……
3. 超声波模块缺陷：测距不准、返回结果异常
4. 障碍物不合适：反射率低（障碍物被忽视）、表面积太小（障碍物被忽视）、反射面不规则（测距结果不准）

## 运作原理

声波遇到障碍物会进行反射。从发射声波的时候开始计时，在倾听到反射的声波时停止计时。
由于声波在各介质中的传播速度较为稳定，便可以通过传播时间算得障碍物距离。

## 使用方法

1. 硬件连接
2. 将源代码烧录至硬件
3. 给硬件供电
4. 等待一秒钟，等硬件的电气特性稳定下来
5. 将障碍物在超声波模块正前方尽量平行地缓慢前后移动
5. 观察显示屏的显示结果
6. 测试完成后，断电

## 硬件规格

1. ESP32 开发板一块
2. ST7789 驱动的TFT屏幕一块
3. US-025 或同规格的超声波测距模块一块
4. 若干连接线
5. 稳定的电源供应非常重要
6. 障碍物，需要反射率高（金属等难以穿透的物质）、表面积较大（至少乒乓球大小）、反射面平滑（最好是平面）

## 软件规格

1. Arduino IDE
2. ESP32 Arduino 支持包
3. Adafruit ST7789 库
4. 本仓库源代码

## 硬件连接

超声波模块使用 5.0V 供电，下表提供逻辑引脚连接指示。

|超声波模块|开发板|
|---|---|
|Trig|39|
|Echo|36|

TFT屏幕使用 3.3V 电压供电，下表提供逻辑引脚连接指示。

|TFT屏幕|开发板|
|---|---|
|SCL|18(SPI SCK)|
|SDA|23(SPI MOSI)|
|RES(RST)|2|
|DC|4|
|BLK|置空|


## 不足与展望

1. 超声波测距是一个阻塞操作，因为声速太慢了，需要等声音回传。如果使用电磁波测试手段会更快更好。
2. 即使多次测量并进行平均，测试结果仍有些许波动，不够平滑。可以尝试更好用的平滑算法。
3. 正常工作时，有时会受到干扰，短时间内的测距结果会稳定在一个异常值，原因不详。重新上电或者快速调节障碍物距离可以解决。
4. 无法分辨障碍物类型。无法探测水下地形，只能识别到水面高度。原因是超声波频率太高，通过液体时会消耗大量能量。解决方法：加大功率或减小频率。


## 运行截图

![不停移动障碍物的测试结果](不停移动障碍物的测试结果.jpg)
![覆盖了之前测试结果的新结果](覆盖了之前测试结果的新结果.jpg)
